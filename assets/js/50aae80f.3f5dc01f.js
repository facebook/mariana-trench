"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[1127],{55097(e,n,i){i.r(n),i.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>l,toc:()=>d});const l=JSON.parse('{"id":"build-from-source","title":"Build from Source","description":"This documentation aims to help you build Mariana Trench from source and run the tests.","source":"@site/documentation/build_from_source.md","sourceDirName":".","slug":"/build-from-source","permalink":"/docs/build-from-source","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/mariana-trench/tree/main/documentation/website/documentation/build_from_source.md","tags":[],"version":"current","frontMatter":{"id":"build-from-source","title":"Build from Source","sidebar_label":"Build from Source"},"sidebar":"docs","previous":{"title":"Feature Glossary","permalink":"/docs/feature-descriptions"},"next":{"title":"Debugging False Positives/False Negatives","permalink":"/docs/debugging-fp-fns"}}');var r=i(74848),t=i(28453);const s={id:"build-from-source",title:"Build from Source",sidebar_label:"Build from Source"},a=void 0,o={},d=[{value:"Supported Platforms",id:"supported-platforms",level:2},{value:"Dependencies",id:"dependencies",level:2},{value:"Building and Installing",id:"building-and-installing",level:2},{value:"Install all dependencies with Homebrew",id:"install-all-dependencies-with-homebrew",level:3},{value:"Clone the repository",id:"clone-the-repository",level:3},{value:"Installation directory",id:"installation-directory",level:3},{value:"Building fmt",id:"building-fmt",level:3},{value:"Building Redex",id:"building-redex",level:3},{value:"Building Mariana Trench",id:"building-mariana-trench",level:3},{value:"Testing during development",id:"testing-during-development",level:2},{value:"Running the tests",id:"running-the-tests",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"CMake Warning: Ignoring extra path from command line: &quot;..&quot;",id:"cmake-warning-ignoring-extra-path-from-command-line-",level:3},{value:"error: externally-managed-environment",id:"error-externally-managed-environment",level:3},{value:"undefined reference to <code>pthread_create@GLIBC</code>",id:"undefined-reference-to-pthread_createglibc",level:3},{value:"error: ZLIB::ZLIB target not found",id:"error-zlibzlib-target-not-found",level:3}];function c(e){const n={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"This documentation aims to help you build Mariana Trench from source and run the tests."}),"\n",(0,r.jsx)(n.h2,{id:"supported-platforms",children:"Supported Platforms"}),"\n",(0,r.jsxs)(n.p,{children:["Mariana Trench is currently supported on ",(0,r.jsx)(n.strong,{children:"macOS"})," (tested on ",(0,r.jsx)(n.em,{children:"Big Sur 11.4"}),"), ",(0,r.jsx)(n.strong,{children:"Linux"})," (tested on ",(0,r.jsx)(n.em,{children:"Ubuntu 20.04 LTS"}),"), and ",(0,r.jsx)(n.strong,{children:"Android"})," (via ",(0,r.jsx)(n.em,{children:"Termux"}),")."]}),"\n",(0,r.jsx)(n.h2,{id:"dependencies",children:"Dependencies"}),"\n",(0,r.jsxs)(n.p,{children:["Below is a list of the required dependencies. Most of them can be installed with ",(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.a,{href:"https://brew.sh/",children:"Homebrew"})}),"."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"A C++ compiler that supports C++20"}),"\n",(0,r.jsx)(n.li,{children:"Python >= 3.6"}),"\n",(0,r.jsx)(n.li,{children:"CMake >= 3.19.3"}),"\n",(0,r.jsx)(n.li,{children:"zlib"}),"\n",(0,r.jsx)(n.li,{children:"Boost >= 1.75.0"}),"\n",(0,r.jsx)(n.li,{children:"GoogleTest >= 1.10.0"}),"\n",(0,r.jsx)(n.li,{children:"JsonCpp >= 1.9.4"}),"\n",(0,r.jsx)(n.li,{children:"fmt >= 7.1.2, <= 9.1.0"}),"\n",(0,r.jsx)(n.li,{children:"RE2"}),"\n",(0,r.jsx)(n.li,{children:"Java (Optional)"}),"\n",(0,r.jsx)(n.li,{children:"Android SDK (Optional)"}),"\n",(0,r.jsx)(n.li,{children:"Redex (master)"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"building-and-installing",children:"Building and Installing"}),"\n",(0,r.jsx)(n.h3,{id:"install-all-dependencies-with-homebrew",children:"Install all dependencies with Homebrew"}),"\n",(0,r.jsxs)(n.p,{children:["First, follow the instructions to install ",(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.a,{href:"https://brew.sh/",children:"Homebrew"})})," on your system."]}),"\n",(0,r.jsx)(n.p,{children:"Then, make sure homebrew is up-to-date:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"$ brew update\n$ brew upgrade\n"})}),"\n",(0,r.jsx)(n.p,{children:"Finally, install all the dependencies."}),"\n",(0,r.jsxs)(n.p,{children:["On ",(0,r.jsx)(n.strong,{children:"macOS"}),", run:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"$ brew install python3 git cmake zlib boost googletest jsoncpp re2\n"})}),"\n",(0,r.jsxs)(n.p,{children:["On ",(0,r.jsx)(n.strong,{children:"Linux"}),", run:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"$ brew install git cmake zlib boost jsoncpp re2\n$ brew install googletest --build-from-source # The package is currently broken.\n$ export CMAKE_PREFIX_PATH=/home/linuxbrew/.linuxbrew/opt/jsoncpp:/home/linuxbrew/.linuxbrew/opt/zlib\n"})}),"\n",(0,r.jsxs)(n.p,{children:["On ",(0,r.jsx)(n.strong,{children:"Linux"}),", you will need to install Java to run the tests. For instance, on ",(0,r.jsx)(n.strong,{children:"Ubuntu"}),", run:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"$ sudo apt install default-jre default-jdk\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"On Android (Termux):"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"$ pkg install -y git zlib boost googletest jsoncpp openjdk-17 jsoncpp-static boost-headers binutils build-essential rsync\n"})}),"\n",(0,r.jsx)(n.p,{children:"On Termux, you will also need to build RE2 and Google Benchmark from source:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'# Build RE2\n$ cd "$HOME"\n$ git clone https://github.com/google/re2.git --depth 1\n$ cd re2/\n$ cmake -DCMAKE_INSTALL_PREFIX="$MARIANA_TRENCH_DIRECTORY/install" -S . -B build\n$ cd build\n$ make\n$ make install\n\n# Build benchmark\n$ cd "$HOME"\n$ git clone https://github.com/google/benchmark.git --depth 1\n$ cd benchmark\n$ cmake -DBENCHMARK_DOWNLOAD_DEPENDENCIES=on -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="$MARIANA_TRENCH_DIRECTORY/install" -DBENCHMARK_ENABLE_GTEST_TESTS=OFF -S . -B "build"\n$ cmake --build "build" --config Release --target install\n'})}),"\n",(0,r.jsx)(n.p,{children:"And, you also need to clone libbinder (required for building Redex):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'$ git clone https://github.com/D-os/libbinder.git --depth 1 "$TMPDIR/libbinder"\n'})}),"\n",(0,r.jsx)(n.h3,{id:"clone-the-repository",children:"Clone the repository"}),"\n",(0,r.jsxs)(n.p,{children:["First of, clone the Mariana Trench repository. We will also set an environment variable ",(0,r.jsx)(n.code,{children:"MARIANA_TRENCH_DIRECTORY"})," that points to it for the following instructions."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'$ git clone https://github.com/facebook/mariana-trench.git\n$ cd mariana-trench\n$ MARIANA_TRENCH_DIRECTORY="$PWD"\n'})}),"\n",(0,r.jsx)(n.h3,{id:"installation-directory",children:"Installation directory"}),"\n",(0,r.jsx)(n.p,{children:'We do not recommend installing Mariana Trench as root. Instead, we will install all libraries and binaries in a directory "install".\nWe will also use a directory called "dependencies" to store dependencies that we have to build from source.\nRun the following commands:'}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"$ mkdir install\n$ mkdir dependencies\n"})}),"\n",(0,r.jsx)(n.h3,{id:"building-fmt",children:"Building fmt"}),"\n",(0,r.jsxs)(n.p,{children:["The 9.0 release of ",(0,r.jsx)(n.code,{children:"fmt"})," has breaking changes that Mariana Trench is not yet compatible with, so for now, you need to build the library from source. You will need to do the following:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'$ cd "$MARIANA_TRENCH_DIRECTORY/dependencies"\n$ git clone -b 9.1.0 https://github.com/fmtlib/fmt.git\n$ mkdir fmt/build\n$ cd fmt/build\n$ cmake -DCMAKE_CXX_STANDARD=17 -DFMT_TEST=OFF -DCMAKE_INSTALL_PREFIX="$MARIANA_TRENCH_DIRECTORY/install" ..\n$ make -j4\n$ make install\n'})}),"\n",(0,r.jsx)(n.h3,{id:"building-redex",children:"Building Redex"}),"\n",(0,r.jsxs)(n.p,{children:["We also need to build ",(0,r.jsx)(n.a,{href:"https://fbredex.com/",children:"Redex"})," from source."]}),"\n",(0,r.jsx)(n.p,{children:"First, navigate to the dependencies directory and clone Redex:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'$ cd "$MARIANA_TRENCH_DIRECTORY/dependencies"\n$ git clone https://github.com/facebook/redex.git\n$ mkdir redex/build\n$ cd redex/build\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Then, run ",(0,r.jsx)(n.code,{children:"cmake"})," with platform-specific flags:"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"On macOS/Linux:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'$ cmake -DCMAKE_INSTALL_PREFIX="$MARIANA_TRENCH_DIRECTORY/install" ..\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"On Termux:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'$ cmake -DCMAKE_INSTALL_PREFIX="$MARIANA_TRENCH_DIRECTORY/install" -DCMAKE_CXX_FLAGS="-I$TMPDIR/libbinder/include" ..\n'})}),"\n",(0,r.jsx)(n.p,{children:"Finally, build and install Redex:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"$ make -j4\n$ make install\n"})}),"\n",(0,r.jsx)(n.h3,{id:"building-mariana-trench",children:"Building Mariana Trench"}),"\n",(0,r.jsx)(n.p,{children:"Now that we have our dependencies ready, let's build the Mariana Trench binary:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'$ cd "$MARIANA_TRENCH_DIRECTORY"\n$ mkdir build\n$ cd build\n$ cmake \\\n  -DREDEX_ROOT="$MARIANA_TRENCH_DIRECTORY/install" \\\n  -Dfmt_ROOT="$MARIANA_TRENCH_DIRECTORY/install" \\\n  -DCMAKE_INSTALL_PREFIX="$MARIANA_TRENCH_DIRECTORY/install" \\\n  ..\n$ make -j4\n$ make install\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Finally, let's install Mariana Trench as a Python package.\nFirst, follow the instructions to create a ",(0,r.jsx)(n.a,{href:"https://packaging.python.org/tutorials/installing-packages/#creating-virtual-environments",children:"virtual environment"}),".\nOnce inside a virtual environment (after using the ",(0,r.jsx)(n.code,{children:"activate"})," script), run:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'$ cd "$MARIANA_TRENCH_DIRECTORY"\n$ python scripts/setup.py \\\n  --binary "$MARIANA_TRENCH_DIRECTORY/install/bin/mariana-trench-binary" \\\n  --pyredex "$MARIANA_TRENCH_DIRECTORY/install/bin/pyredex" \\\n  install\n'})}),"\n",(0,r.jsx)(n.h2,{id:"testing-during-development",children:"Testing during development"}),"\n",(0,r.jsxs)(n.p,{children:["If you are making changes to Mariana Trench, you can use the ",(0,r.jsx)(n.code,{children:"mariana-trench"})," wrapper inside the build directory:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"$ cd build\n$ ./mariana-trench --help\n"})}),"\n",(0,r.jsxs)(n.p,{children:["This way, you don't have to call ",(0,r.jsx)(n.code,{children:"scripts/setup.py"})," between every changes.\nPython changes will be automatically picked up.\nC++ changes will be picked up after running ",(0,r.jsx)(n.code,{children:"make"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"Note that you will need to install all python dependencies:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"$ pip install pyre_extensions fb-sapp\n"})}),"\n",(0,r.jsx)(n.h2,{id:"running-the-tests",children:"Running the tests"}),"\n",(0,r.jsx)(n.p,{children:"To run the tests after building Mariana Trench, use:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"$ cd build\n$ make check\n"})}),"\n",(0,r.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,r.jsx)(n.p,{children:"Here are a set of errors you might encounter, and their solutions."}),"\n",(0,r.jsx)(n.h3,{id:"cmake-warning-ignoring-extra-path-from-command-line-",children:'CMake Warning: Ignoring extra path from command line: ".."'}),"\n",(0,r.jsxs)(n.p,{children:["You probably tried to run ",(0,r.jsx)(n.code,{children:"cmake"})," from the wrong directory.\nMake sure that ",(0,r.jsx)(n.code,{children:"$MARIANA_TRENCH_DIRECTORY"})," is set correctly (test with ",(0,r.jsx)(n.code,{children:"echo $MARIANA_TRENCH_DIRECTORY"}),").\nThen, run the instructions again from the beginning of the section you are in."]}),"\n",(0,r.jsx)(n.h3,{id:"error-externally-managed-environment",children:"error: externally-managed-environment"}),"\n",(0,r.jsxs)(n.p,{children:["You probably tried to run ",(0,r.jsx)(n.code,{children:"python scripts/setup.py"})," without a virtual environment. Create a ",(0,r.jsx)(n.a,{href:"https://packaging.python.org/tutorials/installing-packages/#creating-virtual-environments",children:"virtual environment"})," first."]}),"\n",(0,r.jsxs)(n.h3,{id:"undefined-reference-to-pthread_createglibc",children:["undefined reference to ",(0,r.jsx)(n.code,{children:"pthread_create@GLIBC"})]}),"\n",(0,r.jsx)(n.p,{children:"This seems to happen on Linux, when your operating system has an old version of glibc, which doesn't match the version used by Homebrew.\nTry upgrading your operating system to the last version."}),"\n",(0,r.jsx)(n.p,{children:"Another option is to use the compiler (gcc) from Homebrew directly:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"$ brew install gcc\nexport CC=/home/linuxbrew/.linuxbrew/bin/cc\nexport CXX=/home/linuxbrew/.linuxbrew/bin/c++\n"})}),"\n",(0,r.jsxs)(n.p,{children:["You will need to run all the instructions from this page again, starting from ",(0,r.jsx)(n.code,{children:"Clone the repository"}),". We recommend starting from scratch, i.e delete the mariana-trench directory."]}),"\n",(0,r.jsx)(n.h3,{id:"error-zlibzlib-target-not-found",children:"error: ZLIB::ZLIB target not found"}),"\n",(0,r.jsx)(n.p,{children:"The following error indicates that cmake failed to find zlib:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'CMake Error at CMakeLists.txt:131 (target_link_libraries):\n  Target "redex-all" links to:\n\n    ZLIB::ZLIB\n\n  but the target was not found.\n'})}),"\n",(0,r.jsxs)(n.p,{children:["This can be fixed by providing the path to zlib when running ",(0,r.jsx)(n.code,{children:"cmake"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"cmake [options] -DZLIB_HOME=/path/to/zlib ..\n"})}),"\n",(0,r.jsxs)(n.p,{children:["(Note how the ",(0,r.jsx)(n.code,{children:"cmake"})," command must end with ",(0,r.jsx)(n.code,{children:".."})," to refer to the parent directory)"]}),"\n",(0,r.jsx)(n.p,{children:"If zlib was installed with Homebrew (common on macOS), use:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'cmake [options] -DZLIB_HOME="$(brew --prefix)/opt/zlib" ..\n'})})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},28453(e,n,i){i.d(n,{R:()=>s,x:()=>a});var l=i(96540);const r={},t=l.createContext(r);function s(e){const n=l.useContext(t);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),l.createElement(t.Provider,{value:n},e.children)}}}]);